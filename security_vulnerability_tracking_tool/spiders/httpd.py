import scrapy
import pandas as pd
from pandas import ExcelWriter

class HttpdSpider(scrapy.Spider):
    name = 'httpd'
    allowed_domains = ['httpd.apache.org']
    start_urls = ['https://httpd.apache.org/security/vulnerabilities_24.html']

    def parse(self, response):
        #impact_Rating=
        advisory=response.xpath('//name/text()').extract()
        cve_Id  =response.xpath('//h3/a/text()').extract()
        link    =response.xpath('//h3/a/@href').extract()
        #description=response.xpath('//dl/dd/p[2]/text()').extract()
        # acknowledgements=
        reported_To_Security_Team_On= response.xpath('//tr[1]/td[2]//text()').extract()
        issue_Public= response.xpath('//tr[2]/td[2]//text()').extract()
        update_Released= response.xpath('//tr[3]/td[2]//text()').extract()
        #httpd_Versions_Affected= response.xpath('//table/tbody/tr/td[@class="cve-header" and text()="Affects"]').extract()
        #//table/tbody/tr/td[count(//table/thead/tr/th[//table/tbody/tr/td[@class="cve-header" and text()="Affects"]]/preceding-sibling::th)+2]

        # Code for first cve from list
        #yield{'Advisory':advisory[0],"CVE-Id":cve_Id[0] , "CVE0-Link":link[0],
        #        "description":description[0],"acknowledgements":description[1], "Reported to Security Team On ":reported_To_Security_Team_On[0],
        #        "Issue_Public":issue_Public[0],"Update_Released":update_Released[0] }

        # Code for all cves
        try:
            data = {'Advisory':advisory,"CVE-Id":cve_Id , "CVE-Link":link,
                     "Reported to Security Team On ":reported_To_Security_Team_On,
                    "Issue_Public":issue_Public,"Update_Released":update_Released}
            df = pd.DataFrame(data,columns=["CVE-Id", "CVE-Link",'Advisory',
                    "Reported to Security Team On ",
                    "Issue_Public","Update_Released"])
            writer = ExcelWriter("Httpd"+".xlsx")
            print(writer)
            df.to_excel(writer,'CVE Details',index=False)
            writer.save()

        except Exception as e:
            print("type error: " + str(e))
        
        pass
