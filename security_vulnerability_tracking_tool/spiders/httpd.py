import scrapy
import logging
import pandas as pd
from pandas import ExcelWriter
import Notify.sendEmails as ce


class HttpdSpider(scrapy.Spider):
    name = 'Httpd'
    allowed_domains = ['httpd.apache.org']
    start_urls = ['https://httpd.apache.org/security/vulnerabilities_24.html']

    @classmethod
    def parse(self, response):
        impact_Rating = response.xpath('//dt/h3/text()').re('^[lmin]')
        advisory = response.xpath('//name/text()').extract()
        cve_Id = response.xpath('//h3/a/text()').extract()
        versions_Affected = response.xpath(
            '//tr/td[contains(text(), "2.")]/text()').extract()

        # Code for all cves
        modified_Impact_name = []
        for item in impact_Rating:
            if item == 'l':
                item = 'low'
            if item == 'i':
                item = 'important'
            if item == 'm':
                item = 'moderate'
            if item == 'n':
                item = 'n/a'
            modified_Impact_name.append(item)
        impact_Rating = modified_Impact_name

        #to check if already exist
        name = HttpdSpider.name
        url = HttpdSpider.start_urls
        changed = ce.do_need_notify(name, 'Output/' + name + '.xlsx', cve_Id,
                                    advisory[0], url)
        if changed is True:
            try:
                data = {
                    'impact_Rating': impact_Rating,
                    'Advisory': advisory,
                    "CVE-Id": cve_Id,
                    "versions_Affected": versions_Affected
                }
                df = pd.DataFrame(
                    data,
                    columns=[
                        'impact_Rating', "CVE-Id", 'Advisory',
                        "versions_Affected"
                    ])
                writer = ExcelWriter("Output/Httpd" +".xlsx")
                logging.info(name+" Data Updated")
                df.to_excel(writer, 'CVE Details', index=False)
                writer.save()

            except Exception as e:
                print("type error: " + str(e))
        else:
            logging.info(name+" have No new cve")
