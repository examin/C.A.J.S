# -*- coding: utf-8 -*-
import scrapy
import pandas as pd
from pandas import ExcelWriter

class OpensslSpider(scrapy.Spider):
    name = 'openssl'
    allowed_domains = ['www.openssl.org/news/vulnerabilities-1.0.2.html']
    start_urls = ['https://www.openssl.org/news/vulnerabilities-1.0.2.html']
    #CVE_REGEX = re.compile(r'CVE-\d{4}-\d{4,}')
    #VERSION_REGEX = re.compile(r'(\d\d?\.\d\.\d\d?)')

    def parse(self, response):
        impact_Rating = response.xpath('//dl/dt/a[3]').re('.*?\#(.*)?"')
        cve_Id  = response.xpath('//dt/a[contains(text(), "CVE-")]/text()').extract()
        advisory = response.xpath('//*[@id="content"]/div/article/div/dl/dd/text()').extract()
        affected =response.xpath('//dd/ul/li[contains(text(),"1.0.2")]').re('.*?ted(.*?)?\)')
        fixed_in_OpenSSL =response.xpath('//dd/ul/li[contains(text(),"1.0.2")]').re('.*?L(.*?)?[\<|\(]')
        fixed_link=response.xpath('//dl/dd/ul/li/a[contains(text(),"git")]/@href').extract()

        try:
            data = {'Impact Rating':impact_Rating,'Advisory':advisory,"CVE-Id":cve_Id ,"Versions Affected":affected
                    ,'Fixed in OpenSSL':fixed_in_OpenSSL}
            add = {'fixed_link':fixed_link}
            df = pd.DataFrame(data,columns=["Impact Rating","CVE-Id","Advisory",
                    "Versions Affected","Fixed in OpenSSL",])
            additional = pd.DataFrame(add,columns=['fixed_link'])

            now = pd.concat([df, additional], axis=1)
            writer = ExcelWriter("openssl"+".xlsx")
            #print(len(affected))
            now.to_excel(writer,'CVE Details',index=False)
            writer.save()

        except Exception as e:
            print("type error: " + str(e))


    pass
